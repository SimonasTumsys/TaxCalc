#:kivy 2.0.0
#:import utils kivy.utils
#:import Factory kivy.factory.Factory
#:import NoTransition kivy.uix.screenmanager.NoTransition

WindowManager:
    transition: NoTransition()
    MainWindow:
    CalcWindow:
    EarnWindow:
    StatWindow:
    SettWindow:
    AboutWindow:

<MainWindow>:
    ## App's background color
    canvas.before:
        Color:
            rgba: utils.get_color_from_hex(app.colors['bg_main']) ## Background grey

        Rectangle:
            pos: self.pos
            size: self.size

    name: "main"
    size: root.size

    ##Main window layout:

    FloatLayout:
        Image: ##App banner
            id: main_banner
            source: './images/banner_small.png' if app.settings['language'] == 'en' else './images/banner_small_lt.png'
            size: self.texture_size
            pos_hint: {'center_x':0.5, 'center_y': 0.825}
            size_hint: (0.8, 0.8)

        BoxLayout: #Button container with layout, size and spacing
            spacing: 10
            orientation: "vertical"
            size_hint: 0.80, 0.575
            pos_hint: {'center_x': .5, 'center_y': .4}

        ##Main window buttons:

            StrokeButton: ##Calculator button 
                font_size: (root.width + root.height) / 30
                text: app.get_lang()[0]['calc']
                font_name: 'DejaVuSans'
                on_release:
                    app.root.current = "calc"

            StrokeButton: ##Enter earnings button
                font_size: (root.width + root.height) / 30
                text: app.get_lang()[0]['enter_earn']
                font_name: 'DejaVuSans'
                on_release:
                    app.root.current = "earn"
                    app.root.get_screen('earn').show_smaller_table()

            
            StrokeButton: ##Statistics button
                font_size: (root.width + root.height) / 30
                text: app.get_lang()[0]['stats']
                font_name: 'DejaVuSans'
                
            StrokeButton: ##Settings button
                font_size: (root.width + root.height) / 30
                text: app.get_lang()[0]['sett']
                font_name: 'DejaVuSans'
                on_release:
                    app.root.current = 'sett'
            
            StrokeButton: ##About button
                font_size: (root.width + root.height) / 30
                text: app.get_lang()[0]['about']
                font_name: 'DejaVuSans'
                on_release:
                    app.root.current = 'about'


<CalcWindow>:
    name: "calc"

    canvas.before:
        Color:
            rgba: utils.get_color_from_hex(app.colors['bg_main'])
        Rectangle:
            pos: self.pos
            size: self.size

    GridLayout:
        size_hint: 0.85, 0.5
        pos_hint: {'center_x': .5, 'center_y': .65}
        cols: 1
        spacing: [0,10]
        
        TextInput:
            pos_hint: {'center_x': .5, 'center_y': .85}
            size_hint: 0.4, 0.2
            id: total_earnings
            multiline: False
            font_size: (root.width + root.height) / 55
            hint_text: app.get_lang()[1]['input_ph']
            hint_text_color: app.colors['hint_text']
            input_filter: 'float'

        TextInput:
            id: costs
            size_hint_y: 0.2
            height: 0
            background_color: 1,1,1,1
            multiline: False
            font_size: (root.width + root.height) / 55
            hint_text: app.get_lang()[1]['cost_ph'] if app.settings['spend_30_percent'] == False else app.get_lang()[1]['auto_cost']
            hint_text_color: app.colors['hint_text']
            input_filter: 'float'
            disabled: True if app.settings['spend_30_percent'] == True else False

        
        GridLayout:
            cols: 2
            spacing: [30,100]
            row_force_default: True
            row_default_height: self.height*0.2
            StrokeButton:
                font_size: (root.width + root.height) / 35
                text: app.get_lang()[1]['submit']
                on_release:
                    root.ids.calc_container.clear_widgets() 
                    root.add_calcLayoutWidget() if root.ids.total_earnings.text != '' else root.useless()
                    root.ids.total_earnings.text = ''
                    root.ids.costs.text = ''


            StrokeButton:
                font_size: (root.width + root.height) / 35
                text: app.get_lang()[1]['back']
                on_release:
                    root.ids.total_earnings.text = ''
                    root.ids.calc_container.clear_widgets()
                    app.root.current = "main"
                    

    BoxLayout:
        orientation: 'vertical'
        size_hint: 0.8, 0.5
        pos_hint: {'center_x': .5, 'center_y': .35}
        id: calc_container


               
<EarnWindow>:
    name: "earn"
    
    canvas.before:
        Color:
            rgba: utils.get_color_from_hex(app.colors['bg_main'])
        Rectangle:
            pos: self.pos
            size: self.size

    GridLayout:
        size_hint: 0.85, 0.5
        pos_hint: {'center_x': .5, 'center_y': .75}
        cols: 1
        spacing: [0,10]

        GridLayout:
            cols: 1
            id: pb_container
            size_hint_y: 0.1 


        BoxLayout:
            pos_hint: {'center_x': .5, 'center_y': .5}
            size_hint: 1, 0.5
            orientation: 'vertical'

            Label:
                halign: 'left'
                text_size: self.size
                text: 'Pasirinkite aplanką su Bolt/Wolt PDF'
                color: utils.get_color_from_hex(app.colors['font_black'])

            FileManager:
        
        GridLayout:
            cols: 2
            spacing: [30,100]
            row_force_default: True
            row_default_height: self.height*0.2

            StrokeButton:
                font_size: (root.width + root.height) / 35
                text: app.get_lang()[2]['scan']
                on_release:
                    root.scan_fs()
                    root.handle_pdf()
                    root.ids.db_container.clear_widgets()    
                    root.show_smaller_table()
                    
            StrokeButton:
                font_size: (root.width + root.height) / 35
                text: app.get_lang()[2]['back']
                on_release:
                    root.ids.db_container.clear_widgets()   
                    app.root.current = 'main'


    ScrollView:
        size_hint: 0.8, 0.55
        pos_hint: {'center_x': .5, 'center_y': .4}
        do_scroll_x: False
        do_scroll_y: True
        GridLayout:
            size: (root.width, root.height)
            size_hint_x: 1
            size_hint_y: None
            cols: 3
            height: self.minimum_height
            row_default_height: '30dp'
            row_force_default: True
            id: db_container


<TableButton>:
    background_color: (0,0,0,0)
    background_normal: ''
    font_black_color: utils.get_color_from_hex(app.colors['font_black'])
    back_color: utils.get_color_from_hex(app.colors['btn_bg']) ## White
    back_color_press: utils.get_color_from_hex(app.colors['btn_side']) ## Dark Green
    font_color_press: utils.get_color_from_hex(app.colors['font']) ## Font Grey
    ##Font color:
    color: self.font_black_color if self.state == 'normal' else self.font_color_press
    size: '30dp', '30dp'
    size_hint_x: 0.5
    size_hint_y: None
    canvas.before:
        Color:
            rgba: self.back_color or [0,0,0,0] if self.state == 'normal' else self.back_color_press or [0,0,0,0] 
        Rectangle:
            size: self.size
            pos: self.pos
        ##Line around button:
    canvas.after:
        Color:
            rgba: self.back_color_press or [0,0,0,0]
        Line:  
            rectangle: (self.pos[0], self.pos[1], self.size[0], self.size[1])


<StatWindow>:
    name: "stat"

<SettWindow>:
    name: "sett"

    canvas.before:
        Color:
            rgba: utils.get_color_from_hex(app.colors['bg_main'])
        Rectangle:
            pos: self.pos
            size: self.size

    ##Main layout
    BoxLayout:
        orientation: 'vertical'
        spacing: 10
        
        ##Language setting layout
        BoxLayout:
            orientation: 'horizontal'
            spacing: 5
            padding: [0,0,30,0]

            ##Language setting label and button
            SettingsLabel:
                text: app.get_lang()[4]['lang']
            BoxLayout:
                orientation: 'horizontal'
                spacing: 5
                SettingsToggleButton:
                    id: lng_button_lt
                    text: 'Lietuvių'
                    group: 'lng'
                    state: 'down' if app.settings['language'] == 'lt' else 'normal'
                    
                SettingsToggleButton:
                    id: lng_button_en
                    text: 'English'
                    group: 'lng'
                    state: 'down' if app.settings['language'] == 'en' else 'normal'

        Separator:

        ##PSD setting layout
        BoxLayout:
            orientation: 'horizontal'
            spacing: 5
            padding: [0,0,30,0]

            SettingsLabel:
                text: app.get_lang()[4]['fixed_psd']
            BoxLayout:
                orientation: 'horizontal'
                spacing: 5
                SettingsToggleButton:
                    id: psd_button_true
                    text: app.get_lang()[4]['yes']
                    group: 'psd'
                    state: 'down' if app.settings['psd_fixed'] == True else 'normal'
                SettingsToggleButton:
                    id: psd_button_false
                    text: app.get_lang()[4]['no']
                    group: 'psd'
                    state: 'down' if app.settings['psd_fixed'] == False else 'normal'

        Separator:

        ##Spending setting layout
        BoxLayout:
            orientation: 'horizontal'
            spacing: 5
            padding: [0,0,30,0]

            ##Spending setting label and button
            SettingsLabel:
                text: app.get_lang()[4]['spend_30']
                halign: 'center'
            BoxLayout:
                orientation: 'horizontal'
                spacing: 5
                SettingsToggleButton:
                    id: spend_button_true
                    text: app.get_lang()[4]['yes']
                    group: 'spend'
                    state: 'down' if app.settings['spend_30_percent'] == True else 'normal'
                SettingsToggleButton:
                    id: spend_button_false
                    text: app.get_lang()[4]['no']
                    group: 'spend'
                    state: 'down' if app.settings['spend_30_percent'] == False else 'normal'


        Separator:

        ##Pension setting layout
        BoxLayout:
            orientation: 'horizontal'
            spacing: 5
            padding: [0,0,30,0]

            ##Pension setting label and button
            SettingsLabel:
                text: app.get_lang()[4]['pension']
            BoxLayout:
                orientation: 'horizontal'
                spacing: 5
                SettingsToggleButton:
                    id: pension0
                    text: '0'
                    group: 'pension'
                    state: 'down' if app.settings['pension'] == 0 else 'normal'
                SettingsToggleButton:
                    id: pension27
                    text: '2.7%'
                    group: 'pension'
                    state: 'down' if app.settings['pension'] == 2.7 else 'normal'
                SettingsToggleButton:
                    id: pension3
                    text: '3%'
                    group: 'pension'
                    state: 'down' if app.settings['pension'] == 3 else 'normal'
                    
        Separator:

        GridLayout:
            cols: 2
            spacing: [30,100]
            row_force_default: True
            row_default_height: self.height*0.5
            padding: 30
            StrokeButton:
                font_size: (root.width + root.height) / 35
                text: app.get_lang()[4]['save']
                on_release:
                    Factory.TakeEffectPopup().open()

            StrokeButton:
                font_size: (root.width + root.height) / 35
                text: app.get_lang()[4]['cancel']
                on_release: 
                    app.root.current = "main"
    

    HelpButton:
        pos_hint: {'x':0.013, 'y':0.775}
        id: psd_help_button
        on_release: Factory.PSDHelpPopup().open()

    HelpButton:
        pos_hint: {'x':0.013, 'y':0.57}
        id: spending_help_button
        on_release: Factory.SpendHelpPopup().open()

    HelpButton:
        pos_hint: {'x':0.013, 'y':0.364}
        id: pension_help_button
        on_release: Factory.PensionHelpPopup().open()



<AboutWindow>:
    ## App's background color
    canvas.before:
        Color:
            rgba: utils.get_color_from_hex(app.colors['bg_main']) ## Background grey

        Rectangle:
            pos: self.pos
            size: self.size

    name: "about"
    size: root.size





<FileManager>:
    BoxLayout:
        orientation: 'horizontal'
        TextInput:
            id: path_label
            pos_hint: {'center_x': .5, 'center_y': .5}
            size_hint: 0.8, 0.7
            multiline: False
            font_size: (root.width + root.height) / 28
            hint_text: app.path['main_path']
            hint_text_color: app.colors['hint_text']
            disabled: True

        MDIconButton:
            halign: 'right'
            text_size: self.size
            icon: "folder"
            # icon_size: 0.5, 0.5
            pos_hint: {'x': .5, 'y': .05}
            on_release: root.file_manager_open()


<Separator@Widget>:
    id: separator
    size_hint_y: None
    height: 6
    canvas:
        Color:
            rgb: 0., 0., 0.
        Rectangle:
            pos: 0, separator.center_y
            size: separator.width, 2

<StyledButton@Button>:
    background_color: (0,0,0,0)
    background_normal: ''
    font_black_color: utils.get_color_from_hex(app.colors['font_black'])
    back_color: utils.get_color_from_hex(app.colors['btn_bg']) ## White
    back_color_press: utils.get_color_from_hex(app.colors['btn_side']) ## Dark Green
    font_color_press: utils.get_color_from_hex(app.colors['font']) ## Font Grey
    ##Font color:
    color: self.font_black_color if self.state == 'normal' else self.font_color_press

<StrokeButton@StyledButton>:
    border_radius: 25
    canvas.before:
    ##Color when pressed and not pressed:
        Color:
            rgba: self.back_color or [0,0,0,0] if self.state == 'normal' else self.back_color_press or [0,0,0,0] 
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [25]
    ##Line around button:
    canvas.after:
        Color:
            rgba: self.back_color_press or [0,0,0,0]
        Line:  
            rounded_rectangle: (self.pos[0], self.pos[1], self.size[0], self.size[1], self.border_radius)
            width: 2

<SettingsToggleButton@ToggleButton>:
    font_size: (root.width + root.height) / 8
    background_color: (0,0,0,0)
    background_normal: ''
    font_black_color: utils.get_color_from_hex(app.colors['font_black'])
    back_color: utils.get_color_from_hex(app.colors['btn_bg']) ## Grey
    back_color_press: utils.get_color_from_hex(app.colors['btn_side']) ## Black
    font_color_press: utils.get_color_from_hex(app.colors['font']) ## Font Grey
    size_hint: (0.25, 0.5)
    pos_hint: {'center_x': 0.5, 'center_y': 0.5}
    allow_no_selection: False
    ##Font color when pressed and not pressed
    color: self.font_black_color if self.state == 'normal' else self.font_color_press
    ##Color when pressed and not pressed
    canvas.before:
        Color:
            rgba: self.back_color or [0,0,0,0] if self.state == 'normal' else self.back_color_press or [0,0,0,0] 
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [15]

<HelpButton@StyledButton>:
    size_hint: (0.05, 0.025)
    font_size: (root.width + root.height) / 3
    color: self.back_color_press if self.state == 'down' else self.font_color_press
    text: '?'
    canvas.before:
        Color:
            rgba: self.back_color or [0,0,0,0] if self.state == 'down' else self.back_color_press or [0,0,0,0] 
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [5]

<HelpPopup@Popup>:
    size_hint: (0.8, 0.6)
    pos_hint: {'center_x': 0.5, 'center_y': 0.6}
    separator_color: utils.get_color_from_hex(app.colors['font']) ## Font Grey
    separator_height: '1dp'
    title_color: utils.get_color_from_hex(app.colors['font']) ## Font Grey
    title_align: 'center'
    title_size: (root.width + root.height) / 32
    #background_color: utils.get_color_from_hex('#242725')

<PSDHelpPopup@HelpPopup>:
    title: app.get_lang()[4]['fixed_psd']
    BoxLayout:
        orientation: 'vertical'
        PopupLabel:
            text: app.get_lang()[4]['psd_help']

<SpendHelpPopup@HelpPopup>:
    title: app.get_lang()[4]['spend_30']
    BoxLayout:
        orientation: 'vertical'
        PopupLabel:
            text: app.get_lang()[4]['spend_help']


<PensionHelpPopup@HelpPopup>:
    title: app.get_lang()[4]['pension']
    BoxLayout:
        orientation: 'vertical'
        PopupLabel:
            text: app.get_lang()[4]['pension_help']

<TakeEffectPopup@Popup>:
    size_hint: (0.8, 0.25)
    pos_hint: {'center_x': 0.5, 'center_y': 0.6}
    title: ''
    separator_height: 0
    #background_color: utils.get_color_from_hex('#242725')
    auto_dismiss: False
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: app.get_lang()[4]['take_effect']
            font_size: (root.width + root.height) / 35
            color: utils.get_color_from_hex(app.colors['font'])
            valign: 'middle'
            halign: 'center'
            text_size: self.size
        BoxLayout:
            orientation: 'horizontal'
            spacing: 30
            StrokeButton: ##Save and quit button
                font_size: (root.width + root.height) / 35
                text: app.get_lang()[4]['save_quit']
                font_name: 'DejaVuSans'
                size_hint: (1, 0.6)
                on_release:
                    app.root.get_screen('sett').save_settings()
                    app.stop()
            StrokeButton: ##Cancel button
                font_size: (root.width + root.height) / 35
                text: app.get_lang()[4]['cancel']
                font_name: 'DejaVuSans'
                size_hint: (1, 0.6)
                on_release:
                    root.dismiss()


<PopupLabel@Label>:
    valign: 'middle'
    halign: 'center'
    font_size: (root.width + root.height) / 45
    text_size: self.size
    color: utils.get_color_from_hex(app.colors['font'])

<SettingsLabel@Label>:
    font_size: (root.width + root.height) / 13
    color: utils.get_color_from_hex(app.colors['font_black'])
    halign: 'center'

<DataButton@StyledButton>:
    canvas.before:
        Color:
            rgba: self.back_color or [0,0,0,0] if self.state == 'normal' else self.back_color_press or [0,0,0,0] 
        Rectangle:
            size: self.size
            pos: self.pos
    ##Line around button:
    canvas.after:
        Color:
            rgba: self.back_color_press or [0,0,0,0]
        Line:  
            rectangle: (self.pos[0], self.pos[1], self.size[0], self.size[1])

<DataButtonLabel@DataButton>:
    halign: 'left'
    valign: 'middle'
    text_size: self.size
    padding_x: 20

<DataButtonNumbers@DataButton>:
    halign: 'right'
    valign: 'middle'
    text_size: self.size
    padding_x: 20


<CalculatedLayout>:
    pos: self.pos
    rows: 10
    cols: 2
    DataButtonLabel:
        text: app.get_lang()[1]['income']
    DataButtonNumbers:
        text:
            app.root.get_screen('calc').calculate()[0]
    DataButtonLabel:
        text: app.get_lang()[1]['profit']
    DataButtonNumbers:
        text:
            app.root.get_screen('calc').calculate()[1]
    DataButtonLabel:
        text: app.get_lang()[1]['costs']
    DataButtonNumbers:
        text:
            app.root.get_screen('calc').calculate()[2]
    DataButtonLabel:
        text: app.get_lang()[1]['psd']
    DataButtonNumbers:
        text:
            app.root.get_screen('calc').calculate()[3]
    DataButtonLabel:
        text: app.get_lang()[1]['vsd']
    DataButtonNumbers:
        text:
            app.root.get_screen('calc').calculate()[4]
    DataButtonLabel:
        text: app.get_lang()[1]['pension']
    DataButtonNumbers:
        text:
            app.root.get_screen('calc').calculate()[5]
    DataButtonLabel:
        text: app.get_lang()[1]['gpm']
    DataButtonNumbers:
        text:
            app.root.get_screen('calc').calculate()[6]
    DataButtonLabel:
        text: app.get_lang()[1]['net_earn']
    DataButtonNumbers:
        text:
            app.root.get_screen('calc').calculate()[7]
    DataButtonLabel:
        text: app.get_lang()[1]['total_tax']
    DataButtonNumbers:
        text:
            app.root.get_screen('calc').calculate()[8]
    DataButtonLabel:
        text: app.get_lang()[1]['tax_perc']
    DataButtonNumbers:
        text:
            app.root.get_screen('calc').calculate()[9]